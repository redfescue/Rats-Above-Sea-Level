// 12/11/24 notes
//copied from Altimeter_2Nov -see that for previous notes
//now has functioning dashboard
//next, revise sketch to drive linear servo on "Rats Above Sea Level"


/* 
  Sketch generated by the Arduino IoT Cloud Thing "Untitled"
  https://create.arduino.cc/cloud/things/663a8506-8add-4f1a-aec6-98a5f0a0db57 

  Arduino IoT Cloud Variables description

  The following variables are automatically generated and updated when changes are made to the Thing

  float sea_level;
  int altitude;
  int temperature;

  Variables which are marked as READ/WRITE in the Cloud Thing will also have functions
  which are called when their values are changed from the Dashboard.
  These functions are generated with the Thing and added at the end of this sketch.
*/

#include "ArduinoGraphics.h"
#include "Arduino_LED_Matrix.h"

ArduinoLEDMatrix matrix;


#include <Wire.h>
#include <SPI.h>
#include <Adafruit_BMP280.h>
Adafruit_BMP280 bmp; //I2C


#define ALT 9  //PWM for dial altimeter
#define LIN 10 //PWM for linear slider

float LinMin = 760; //pulse width for zero feet on slider
float LinMax = 2040; //pulse witdth for 500 feet on slider

int pulseAlt = 2400; //from 2443 on 11/25/24 
//calibrated pulse width for altimeter servo 10/3/24
int i = 0; 
int u = 0; //variable used to control how often zero calibration happens
float R;
int LinPW; 

#include "thingProperties.h"



void setup() {
  // Initialize serial and wait for port to open:
  Serial.begin(9600);
  // This delay gives the chance to wait for a Serial Monitor without blocking if none is found
  delay(1500); 

  // Defined in thingProperties.h
  initProperties();

  // Connect to Arduino IoT Cloud
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);
  
  /*
     The following function allows you to obtain more information
     related to the state of network and IoT Cloud connection and errors
     the higher number the more granular information youâ€™ll get.
     The default is 0 (only errors).
     Maximum is 4
 */
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();

//11/14/24 added from baseline - it works
  if (!bmp.begin()) {
    Serial.println(F("Could not find a valid BMP280 sensor, check wiring!"));
    while (1);
  }

 bmp.setSampling(Adafruit_BMP280::MODE_NORMAL,     /* Operating Mode. */
                  Adafruit_BMP280::SAMPLING_X2,     /* Temp. oversampling */
                  Adafruit_BMP280::SAMPLING_X16,    /* Pressure oversampling */
                  Adafruit_BMP280::FILTER_X16,      /* Filtering. */
                  Adafruit_BMP280::STANDBY_MS_500); /* Standby time. */

 pinMode(LED_BUILTIN, OUTPUT); 

//added 11/15/24 - verifies OK
 sea_level = 32.2; 

//added 11/16 to help start-up 
altitude = 260;
  
//added 11/16 
pinMode(ALT,OUTPUT); //added 9/14 altimeter ouput pin
pinMode(LIN,OUTPUT); //added 2/11/21 linear slider output

digitalWrite(ALT, LOW);  //added for troubleshooting 10/1
digitalWrite(LIN, LOW); //added 2/11/21 - not sure this is needed

//added 11/23 for LED matrix - works, times unaffected
 matrix.begin();

  matrix.beginDraw();

  matrix.stroke(0xFFFFFFFF);
  matrix.textScrollSpeed(100);

  const char text[] = "  UNO r4  ";
  matrix.textFont(Font_4x6);
  matrix.beginText(0, 1, 0xFFFFFF);
  matrix.println(text);
  matrix.endText(SCROLL_LEFT);

  matrix.endDraw();

}


void loop() {
  ArduinoCloud.update(); 
//added 11/14/24 from baseline, it verifies!  
//section 1 of loop - display temp, altitude, pressure
  Serial.print(F("Temperature = "));
  Serial.print(bmp.readTemperature());
  Serial.println(" *C");

delay(1000);

 Serial.print(F("Pressure = "));
 Serial.print(bmp.readPressure());
 Serial.println(" Pa");

 Serial.println();

 //added 11/15/24 - so dashboard has something to read- verifies OK
temperature = bmp.readTemperature(); 
Serial.println(temperature);
Serial.println();
  
altitude = (bmp.readAltitude(sea_level*33.86))*3.2808;
  if (altitude > 1000) {
    altitude = 500;
      }
   if (altitude < 0) {
     altitude = 0;
   }
  

Serial.print("Altitude   ");  
Serial.println(altitude);
Serial.println();



// loop skip zero calibration - it's annoying if it does it too often
if (u > 3) { u = 0;
}

 if (u == 3) {

Serial.println(u);
Serial.println();

//11/24 try streaming text
matrix.beginDraw();

  matrix.stroke(0xFFFFFFFF);
  matrix.textScrollSpeed(50);

  // add the text
  const char text[] = "    Calibration    ";
  matrix.textFont(Font_5x7);
  matrix.beginText(0, 1, 0xFFFFFF);
  matrix.println(text);
  matrix.endText(SCROLL_LEFT);

  matrix.endDraw();


   

// take dial to zero feet before displaying altitude   
/*for (i=0; i< 150; i++)  {
digitalWrite(ALT, HIGH);
delayMicroseconds(2270);  //was 2370
digitalWrite(ALT, LOW);
delay(20);
 }
*/



//set slider to zero feet and then 500 feet
for (i = 0; i < 400; i++) {

digitalWrite(LIN, HIGH); //start servo pulse
delayMicroseconds(LinMin);  //use to calibrate for zero feet
digitalWrite(LIN, LOW);
delay(20);

}
   
delay(1500);
   
for (i= 0; i < 400; i++) { 

digitalWrite(LIN, HIGH); //start servo pulse
delayMicroseconds(LinMax);  //use to calibrate for 500 feet
digitalWrite(LIN, LOW);
delay(20);
}

delay(1500);
 
   
 }
  
Serial.println(u);
Serial.println();


delay(1000);


// 11/22 add arduino cloud update here for test
ArduinoCloud.update();  

// dial display calculations & drive
/*for (i= 0; i < 150; i++) { 

digitalWrite(ALT, HIGH); //start servo pulse
delayMicroseconds(pulseAlt-altitude*4.026);  
//calibrated 10/3
digitalWrite(ALT, LOW);
delay(20);
}

Serial.println(pulseAlt-altitude*4.026); //to .026 11/25/24
Serial.println();
Serial.println();
*/



  
delay(2000);  

 //calculate PW for slider & print
R= (LinMax-LinMin)/500;
LinPW = altitude*R + LinMin;
Serial.println(LinPW);
Serial.println( "LinPW"   );
Serial.println();  


  
//drive for linear slider
for (i= 0; i < 400; i++) { 

digitalWrite(LIN, HIGH); //start servo pulse
delayMicroseconds(LinPW);  //use to calibrate for zero feet
digitalWrite(LIN, LOW);
delay(20);
}

delay(1500);  


  

 u = u + 1;



  
  
}





/*
  Since SeaLevel is READ_WRITE variable, onSeaLevelChange() is
  executed every time a new value is received from IoT Cloud.
*/
void onSeaLevelChange()  {
  // Add your code here to act upon SeaLevel change
}
